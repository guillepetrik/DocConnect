# Database Setup Guide

Here is a quick guide for the Database Setup

## üìå MySQL Server Installation Steps

### üê≥ Docker approach

Make sure you have Docker installed in your system

#### ‚¨áÔ∏è Downloading a MySQL Server Docker Image

Downloading the server image in a separate step is not strictly necessary; however, performing this step before you create your Docker container ensures your local image is up to date. To download the MySQL Community Edition image from the docker registry, run this command:

```powershell
docker pull mysql:8.0.34
```

This will download the Community Edition of **MySQL 8.0.34**

#### ‚öôÔ∏è Setting up Volumes & Networks

Create docker volumes for the MySQL Server. We will be creting one for data and one for configuration data.

```bash
docker volume create mysql
docker volume create mysql_config
```

We can choose any other name, just try to remember the volume names in future steps.

We should also setup a docker network for our MySQL Server (so our application and database can talk to each other if you prefer this way). If you have a network already, you can ommit this step and use it in the next step.

```bash
docker network create mysqlnet
```

#### üî• Starting a MySQL Server Instance

To start a new Docker container for a MySQL Server, use the following command:

```powershell
docker run -d -v mysql:/var/lib/mysql \
-v mysql_config:/etc/mysql -p 3306:3306 \
--restart unless-stopped \
--network mysqlnet \
--name red_mysql \
-e MYSQL_ROOT_PASSWORD=red_squad_123 \
mysql:8.0.34
```

The `--name` option, for supplying a custom name for your server container, is optional; if no container name is supplied, a random one is generated. For this installation guide, we will use `red_mysql` as the name of the container.

The `--restart` option is for configuring the [restart policy](https://docs.docker.com/config/containers/start-containers-automatically/) for your container. In this example, we set it as `unless-stopped` so it is always started, even after a computer restart; but you can set it to `no`.

The `--network` option is the network we have just created. If you need this to be your application network, you can set this option to that network.

The `-v` options are related to the MySQL Data and Configuration Data. Here you should use the volumes you have just created.

The `-p` option is related to published ports. In our case, we are going to use the port 3306. This will allow any application outside the docker network to access the database.

The `-e MYSQL_ROOT_PASSWORD=red_squad_123` option just assigns a password to the root user, you can substitute **red_squad_123** with the password of your choice. We will need this root user to setup up privileges. If you need the password to be autogenerated, you can ommit this line.

If the Docker image of the specified name and tag has not been downloaded by an earlier **docker pull** or **docker run** command, the image is now downloaded. Initialization for the container begins, and the container appears in the list of running containers when you run the `docker ps` command. For example:

```powershell
$> docker ps

CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS                               NAMES
ff17794129ec   mysql:8.0.34   "docker-entrypoint.s‚Ä¶"   47 seconds ago   Up 45 seconds   0.0.0.0:3306->3306/tcp, 33060/tcp   red_mysql
```

The container initialization might take some time. When the server is ready for use, the *STATUS* of the container in the output of the **docker ps** command changes from *(health: starting)* to *(healthy)*.

The -d option used in the **docker run** command above makes the container run in the background. Use this command to monitor the output from the container:

```powershell
docker logs red_mysql
```

If you decided to not set a root password `-e MYSQL_ROOT_PASSWORD=red_squad_123`. Once initialization is finished, the command's output is going to contain the random password generated for the root user; check the password with, for example, this command:

```powershell
$> docker logs red_mysql 2>&1 | grep GENERATED

GENERATED ROOT PASSWORD: Axegh3kAJyDLaRuBemecis&EShOs
```

#### üì≤ Connecting to MySQL Server from within the Container

Once the server is ready, you can run the **mysql** client within the MySQL Server container you just started, and connect it to the MySQL Server. Use the **docker exec -it** command to start a **mysql** client inside the Docker container you have started, like the following:

```powershell
docker exec -it red_mysql mysql -uroot -p
```

When asked, enter the generated root password (or the provided one). Because the *MYSQL_ONETIME_PASSWORD* option is true by default, after you have connected a mysql client to the server, you must reset the server root password by issuing this statement:

```sql
mysql> ALTER USER 'root'@'localhost' IDENTIFIED BY 'red_squad_123';
```

Substitute **red_squad_123** with the password of your choice. Once the password is reset, the server is ready for use.

#### Container Shell Access

To have shell access to your MySQL Server container, use the **docker exec -it** command to start a bash shell inside the container:

```bash
$> docker exec -it red_mysql bash
bash-4.2#
```

You can then run Linux commands inside the container. For example, to view contents in the server's data directory inside the container, use this command:

```bash
bash-4.2# ls /var/lib/mysql
auto.cnf    ca.pem	     client-key.pem  ib_logfile0  ibdata1  mysql       mysql.sock.lock	   private_key.pem  server-cert.pem  sys
ca-key.pem  client-cert.pem  ib_buffer_pool  ib_logfile1  ibtmp1   mysql.sock  performance_schema  public_key.pem   server-key.pem
```

#### Stopping and Deleting a MySQL Container

To stop the MySQL Server container we have created, use this command:

```powershell
docker stop red_mysql
```

To stop and start again the MySQL Server container with a single command:

```powershell
docker restart red_mysql
```

To delete the MySQL container, stop it first, and then use the docker rm command:

```powershell
docker stop red_mysql
```

```powershell
docker rm red_mysql
```

If you want the Docker volume for the server's data directory to be deleted at the same time, add the -v option to the **docker rm** command.

#### üì≤ Connect to MySQL from an Application in Another Docker Container

By setting up a Docker network, you can allow multiple Docker containers to communicate with each other, so that a client application in another Docker container can access the MySQL Server in the server container.

Then, when you are creating and starting the client containers, use the --network option to put them on network you created. For example:

```powershell
docker run --name=myapp1 --network=mysqlnet -d myapp
```

The *myapp1* container can then connect to the *red_mysql* container with the mysql1 hostname and vice versa, as Docker automatically sets up a DNS for the given container names. In the following example, we run the **mysql** client from inside the **myapp1** container to connect to host *red_mysql* in its own container:

```bash
docker exec -it myapp1 mysql --host=red_mysql --user=myuser --password
```

For other networking techniques for containers, see the [Docker container networking](https://docs.docker.com/engine/userguide/networking/) section in the Docker Documentation.

### üíª Local Installation Approach

#### ü™ü Windows

The simplest and recommended method is to download MySQL Installer (for Windows) and let it install and configure a specific version of MySQL Server as follows:

1. Download MySQL Installer from https://dev.mysql.com/downloads/installer/ and execute it.

2. Determine the setup type to use for the initial installation of MySQL products. For example:

* `Developer Default`: Provides a setup type that includes the selected version of MySQL Server and other MySQL tools related to MySQL development, such as MySQL Workbench.

* `Server Only`: Provides a setup for the selected version of MySQL Server without other products.

* `Custom`: Enables you to select any version of MySQL Server and other MySQL products.

3. Install the server instance (and products) and then begin the server configuration by following the onscreen instructions.

MySQL is now installed. If you configured MySQL as a service, then Windows automatically starts the MySQL server every time you restart the system. Also, this process installs the MySQL Installer application on the local host, which you can use later to upgrade or reconfigure MySQL server.

#### üçé MacOS

MySQL for macOS is available in a number of different forms:

* Native Package Installer, which uses the native macOS installer (DMG) to walk you through the installation of MySQL.

* Compressed TAR archive, which uses a file packaged using the Unix tar and gzip commands. To use this method, you need to open a Terminal window. You do not need administrator privileges using this method; you can install the MySQL server anywhere using this method.

**Installing MySQL on macOS Using Native Packages**

The package is located inside a disk image (.dmg) file that you first need to mount by double-clicking its icon in the Finder. It should then mount the image and display its contents.

To install MySQL using the package installer:

1. Download the disk image (`.dmg`) file (the community version is available [here](https://dev.mysql.com/downloads/mysql/)) that contains the MySQL package installer. Double-click the file to mount the disk image and see its contents.

   Double-click the MySQL installer package from the disk. It is named according to the version of MySQL you have downloaded. For example, for MySQL server 8.0.34 it might be named mysql-8.0.34-macos-10.13-x86_64.pkg.

2. The initial wizard introduction screen references the MySQL server version to install. Click **Continue** to begin the installation.

   The MySQL community edition shows a copy of the relevant GNU General Public License. Click Continue and then Agree to continue.

3. From the **Installation Type** page you can either click `Install` to execute the installation wizard using all defaults, click `Customize` to alter which components to install (MySQL server, MySQL Test, Preference Pane, Launchd Support -- all but MySQL Test are enabled by default).

![Installation Type](images/setup_images/mac-installer-installation-type-standard.png)

![Customize](images/setup_images/mac-installer-installation-type-customize.png)

4. Click `Install` to install MySQL Server. The installation process ends here if upgrading a current MySQL Server installation, otherwise follow the wizard's additional configuration steps for your new MySQL Server installation.

5. After a successful new MySQL Server installation, complete the configuration steps by choosing the default encryption type for passwords, define the root password, and also enable (or disable) MySQL server at startup.

6. The default MySQL 8.0 password mechanism is `caching_sha2_password` (Strong), and this step allows you to change it to `mysql_native_password` (Legacy).

![Password type](images/setup_images/mac-installer-configuration-password-type.png)

7. Define a password for the root user, and also toggle whether MySQL Server should start after the configuration step is complete.

![Define root password](images/setup_images/mac-installer-configuration-password-define.png)

8. `Summary` is the final step and references a successful and complete MySQL Server installation. `Close` the wizard.

![Summary](images/setup_images/mac-installer-summary.png)

## MySQL Shell Installation

### üíª Local Installation Approach

To install MySQL Shell on Microsoft Windows using the MSI Installer, do the following:

1. Download the Windows (x86, 64-bit), MSI Installer package from http://dev.mysql.com/downloads/shell/.

2. When prompted, click **Run**.

3. Follow the steps in the Setup Wizard.

To install MySQL Shell on macOS, do the following:

1. Download the package from http://dev.mysql.com/downloads/shell/

2. Double-click the downloaded DMG to mount it. Finder opens.

3. Double-click the *.pkg* file shown in the Finder window.

4. Follow the steps in the installation wizard.

5. When the installer finishes, eject the DMG. (It can be deleted.)

### üê≥ Docker Approach

The MySQL Container Image has the MySQL Client and Shell included. You can use the same container as the server or use another `mysql` container instance as below:

```powershell
$ docker run -it --network mysqlnet --rm mysql mysql -hred_mysql -uexample-user -p
```

... to run simple mysql client where `red_mysql` is the name of your original `mysql` container (connected to the `mysqlnet` Docker network)

The image can also be used as a client for non-Docker or remote instances:

```powershell
$ docker run -it --rm mysql mysql -hsome.mysql.host -usome-mysql-user -p
```

If we want to use MySQL Shell, we just need to replace `mysql` with `mysqlsh`

```powershell
$ docker run -it --network mysqlnet --rm mysql mysqlsh -hred_mysql -uexample-user -p
```

## ‚öôÔ∏è Initial Database Setup

### üì≤ Connecting with the MySQL Shell

The commands are the same for local and docker installations. The only difference is that docker commands have to prepend the **docker exec** command in each step.

We can login into our local server installation with the following command:

```powershell
mysqlsh -u root -h localhost -P 3306 --sql -p
```

This will open an interactive shell and will prompt you to enter the **root** user password. You can enter the shell in Python, SQL, JavaScript mode with the `--py`, `--sql` and `--js` options respectively. By default, JavaScript is selected. This approach should work for both, local and docker installations.

For MySQL Shell using Docker there are two ways to connect:

* If MySQL Server is installed locally:

```powershell
docker run -it --rm mysql mysqlsh -h host.docker.internal -uroot -p
```

* If MySQL Server is installed in a docker container:

```powershell
docker run -it --network mysqlnet --rm mysql mysqlsh -hred_mysql -uroot -p
```

... where `red_mysql` is the name of your original `mysql` container (connected to the `mysqlnet` Docker network)

### üéä Database, Roles, Privileges and Users Creation

First we have to setup up the Schema, Roles, Privileges and Users with the following command:

```powershell
mysqlsh root@localhost:3306 --sql --save-passwords=never < database/01_database_setup.sql 
```

It will ask for the root password. If you don't want to input your root password when asked, you can use the command below:

```powershell
mysqlsh root:red_squad_123@localhost:3306 --sql --save-passwords=never < database/01_database_setup.sql 
```

... where `red_squad_123` was our password. Remember that using a password on the command line interface can be insecure !!

Optionally, if we want to reset the database, we can do so with:

```powershell
mysqlsh root@localhost:3306 --sql --save-passwords=never < database/00_optional_reset.sql            
```

And that is all for the Sprint 1

## üîó URI Connection String

You can specify a connection to MySQL Server using a URI-like string. Such strings can be used with the MySQL Shell.

> ‚ÑπÔ∏è **Note** : The term ‚ÄúURI-like‚Äù signifies connection-string syntax that is similar to but not identical to the URI (uniform resource identifier) syntax defined by [RFC 3986](https://tools.ietf.org/html/rfc3986)

A URI-like connection string has the following syntax:

```bash
[scheme://][user[:[password]]@]host[:port][/schema][?attribute1=value1&attribute2=value2...
```

For instance, our local server URI will look something like this:

```bash
mysql://dev1:dev1pass@localhost:3306/doc_connect_db
```

## üîÑ Database Schema Migrations

In order to have our database up-to-date whenever there is a change, we are going to use a tool called [FlyWay](https://documentation.red-gate.com/fd/quickstart-how-flyway-works-184127223.html).

You can install FlyWay from the following page: https://documentation.red-gate.com/fd/installers-172490864.html

## Migrations Guide

Make sure you have already executed the database setup script first before following the next steps.

1. Open your FlyWay Desktop Installation and Sign In.

![FlyWay Sign In Page](images/flyway_images/sign_in.png)

2. Open the FlyWay Project.

![Open the Flyway](images/flyway_images/open_project.png)

3. Select `flyway.toml` from the database folder.

![Select flyway.toml](images/flyway_images/finder_open.png)

4. Add a target database.

![Add database](images/flyway_images/project_overview.png)

5. Fill the fields with the credentials, then test and save the database.

![Fill](images/flyway_images/select_database.png)

6. Click on `Run Migrate`

![Migrate](images/flyway_images/migrate_database.png)

7. When the migration is completed, click on the `Generated Flyway Report`.

![Migration Completed](images/flyway_images/migration_completed.png)

8. You will see your current database version, you can close this report.

![Report](images/flyway_images/migration_report.png)

9. If everything went as expected, you will have all the migrations applied.

![Migrations completed](images/flyway_images/migrated_databased.png)

You can then test if the specialties tables have some values with the following:

```powershell
echo "SELECT * FROM specialties" | mysqlsh backend@localhost:3306/doc_connect_db --sql --save-passwords=never
```
## üìñ dbdocs.io Database Documentation

This document provides instructions for generating and updating database documentation using the `dbdocs` tool. The tool enables us to generate detailed documentation and visual diagrams for our database tables and their relationships.

If you don't want to generate the database documentation by yourself, you can check the one [autogenerated](https://dbdocs.io/mateo.fidabel/RedTeam) by GitLab CI

### Installation

Ensure you have Node.js and npm (Node Package Manager) installed on your system. Then, install `dbdocs` globally:
```
npm i -g dbdocs
```
After installing `dbdocs` you can preview available commands by executing:

```dbdocs```

### Login
Login using the following command:
```dbdocs login```

Choose the email method and enter your account details. A token will be sent to your email. Enter the token in the terminal.

### Generate dbdocs View

To generate the database documentation, follow these steps:

a. Locate your `.dbml` file and copy its path.

b. Execute the following command, replacing `<path>` with the copied file path:

```dbdocs build <path>/database.dbml```


###  Access Documentation

A link to the generated documentation will be provided. Open the link in your web browser to view the detailed database documentation and diagrams.

###  Removal (If Needed)

If you need to remove a project from dbdocs, you can use the following command:
```dbdocs remove <project name>```

